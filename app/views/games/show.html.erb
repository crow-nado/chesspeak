<script>
document.addEventListener("DOMContentLoaded", function(){
  let activePiece;
  let destinationSquare
  let activePlayer = "<%= @player_white %>";
  let inactivePlayer = "<%= @player_black %>";

  //Setup Promise to Grab board
  let fetchBoard = fetch("<%= game_pieces_path(@game) %>");

  //Function to populate initial board
  function renderInitialBoard (json) {
    json.forEach( piece => {
      let [x, y] = [piece.x_position, piece.y_position];
      let boardSquare = document.querySelector(`[data-x='${x}'][data-y='${y}']`);
      boardSquare.innerHTML = piece.image;
      boardSquare.setAttribute('data-piece-id', piece.id);
      boardSquare.setAttribute('data-player-id', piece.player_id);
      boardSquare.addEventListener("click", checkActivePiece);
      boardSquare.addEventListener("click", updateActivePiece);
    });
  };

  //Limit "clicked" to one active piece
  function checkActivePiece() {
    let currentSelection = document.querySelector(".clicked");
    if (currentSelection) { currentSelection.classList.remove("clicked") }
  }

  //Add clicked to latest selection
  function updateActivePiece() {
    activePiece = event.target;
    activePiece.classList.add("clicked");
  }

  //Review Destination Square
  function checkDestinationSquare(square) {
    if (document.querySelector(".destination")) {
      document.querySelector(".destination").classList.remove("destination");
    }
    square.classList.add("destination");
    if (square.dataset.playerId) {
      if (activePlayer.id == square.dataset.playerId) {
        alert("You can't capture your own piece!");
      } else {
        alert("Success!");
      }
    }
  }

  //Create payload to send to server
  function updatePieceLocation(pieceID, data) {
    let gameID = "<%= @game.id %>";
    fetch("/games/" + gameID + "/pieces/" + pieceID, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(data),
    })
      .then();
  }
  
  fetchBoard
    .then(response => response.json())
    .then(json => renderInitialBoard(json))
    .catch(error => console.log(error));


  // Maybe attach different event handlers depending on the piece type (instead of for each empty div)
  document.querySelectorAll('.box').forEach( box => {
    box.addEventListener("click", function(event) {
      if (activePiece) {
        let initialSquare = activePiece;
        let destinationSquare = event.target;
        checkDestinationSquare(destinationSquare);

        // let [initialX, initialY] = [initialSquare.dataset.x, initialSquare.dataset.y]
        let [newX, newY] = [destinationSquare.dataset.x, destinationSquare.dataset.y]
        let piecePayload = {piece: {
          x_position: newX,
          y_position: newY,
        }};

        if (!destinationSquare.innerHTML) {
          destinationSquare.innerHTML = initialSquare.innerHTML
        } else { return; }

        destinationSquare.setAttribute("data-player-id", activePlayer.id);
        destinationSquare.setAttribute("data-piece-id", initialSquare.dataset.pieceId);
        initialSquare.classList.remove("clicked");        
        destinationSquare.addEventListener("click", checkActivePiece);
        destinationSquare.addEventListener("click", updateActivePiece);
        initialSquare.removeEventListener("click", checkActivePiece);
        initialSquare.removeEventListener("click", updateActivePiece);
        activePiece = null;

        updatePieceLocation(initialSquare.dataset.pieceId, piecePayload);

        initialSquare.innerHTML = "";
        initialSquare.removeAttribute("data-player-id");
        initialSquare.removeAttribute("data-player-id");
      }
    });
  });

});
</script>
<br />

<div class="text-center">
  <h1><%= @game.name %></h1>
</div>


<div class="grid-x grid-padding-x align-spaced">
  <div class="off-canvas position-bottom" id="submitResponse" data-off-canvas>
    <h3>Is this where you want to move your piece?</h3>
    <button type="button" class="success button" onClick="movePiece()">Move here!</button>
    <button type="button" class="button">No</button>
  </div>

  <div class="cell large-auto">
    <div class="row align-center">
      <div class="wrapper">
        <div class="box-inner"></div>
        <div class="box-inner">A</div>
        <div class="box-inner">B</div>
        <div class="box-inner">C</div>
        <div class="box-inner">D</div>
        <div class="box-inner">E</div>
        <div class="box-inner">F</div>
        <div class="box-inner">G</div>
        <div class="box-inner">H</div>
        <div class="box-inner"></div>
      
        <div class="box-inner">8</div>
        <div class="box"       data-x = "1" data-y = "8"></div>
        <div class="box white" data-x = "2" data-y = "8"></div>
        <div class="box"       data-x = "3" data-y = "8"></div>
        <div class="box white" data-x = "4" data-y = "8"></div>
        <div class="box"       data-x = "5" data-y = "8"></div>
        <div class="box white" data-x = "6" data-y = "8"></div>
        <div class="box"       data-x = "7" data-y = "8"></div>
        <div class="box white" data-x = "8" data-y = "8"></div>
        <div class="box-inner">8</div>


        <div class="box-inner">7</div>
        <div class="box white" data-x="1" data-y="7"></div>
        <div class="box"       data-x="2" data-y="7"></div>
        <div class="box white" data-x="3" data-y="7"></div>
        <div class="box"       data-x="4" data-y="7"></div>
        <div class="box white" data-x="5" data-y="7"></div>
        <div class="box"       data-x="6" data-y="7"></div>
        <div class="box white" data-x="7" data-y="7"></div>
        <div class="box"       data-x="8" data-y="7"></div>
        <div class="box-inner">7</div>

        <div class="box-inner">6</div>
        <div class="box"       data-x = "1" data-y = "6"></div>
        <div class="box white" data-x = "2" data-y = "6"></div>
        <div class="box"       data-x = "3" data-y = "6"></div>
        <div class="box white" data-x = "4" data-y = "6"></div>
        <div class="box"       data-x = "5" data-y = "6"></div>
        <div class="box white" data-x = "6" data-y = "6"></div>
        <div class="box"       data-x = "7" data-y = "6"></div>
        <div class="box white" data-x = "8" data-y = "6"></div>
        <div class="box-inner">6</div>

        <div class="box-inner">5</div>
        <div class="box white" data-x="1" data-y="5"></div>
        <div class="box"       data-x="2" data-y="5"></div>
        <div class="box white" data-x="3" data-y="5"></div>
        <div class="box"       data-x="4" data-y="5"></div>
        <div class="box white" data-x="5" data-y="5"></div>
        <div class="box"       data-x="6" data-y="5"></div>
        <div class="box white" data-x="7" data-y="5"></div>
        <div class="box"       data-x="8" data-y="5"></div>
        <div class="box-inner">5</div>

        <div class="box-inner">4</div>
        <div class="box"       data-x = "1" data-y = "4"></div>
        <div class="box white" data-x = "2" data-y = "4"></div>
        <div class="box"       data-x = "3" data-y = "4"></div>
        <div class="box white" data-x = "4" data-y = "4"></div>
        <div class="box"       data-x = "5" data-y = "4"></div>
        <div class="box white" data-x = "6" data-y = "4"></div>
        <div class="box"       data-x = "7" data-y = "4"></div>
        <div class="box white" data-x = "8" data-y = "4"></div>
        <div class="box-inner">4</div>

        <div class="box-inner">3</div>
        <div class="box white" data-x="1" data-y="3"></div>
        <div class="box"       data-x="2" data-y="3"></div>
        <div class="box white" data-x="3" data-y="3"></div>
        <div class="box"       data-x="4" data-y="3"></div>
        <div class="box white" data-x="5" data-y="3"></div>
        <div class="box"       data-x="6" data-y="3"></div>
        <div class="box white" data-x="7" data-y="3"></div>
        <div class="box"       data-x="8" data-y="3"></div>
        <div class="box-inner">3</div>

        <div class="box-inner">2</div>
        <div class="box"       data-x = "1" data-y = "2"></div>
        <div class="box white" data-x = "2" data-y = "2"></div>
        <div class="box"       data-x = "3" data-y = "2"></div>
        <div class="box white" data-x = "4" data-y = "2"></div>
        <div class="box"       data-x = "5" data-y = "2"></div>
        <div class="box white" data-x = "6" data-y = "2"></div>
        <div class="box"       data-x = "7" data-y = "2"></div>
        <div class="box white" data-x = "8" data-y = "2"></div>
        <div class="box-inner">2</div>

        <div class="box-inner">1</div>
        <div class="box white" data-x="1" data-y="1"></div>
        <div class="box"       data-x="2" data-y="1"></div>
        <div class="box white" data-x="3" data-y="1"></div>
        <div class="box"       data-x="4" data-y="1"></div>
        <div class="box white" data-x="5" data-y="1"></div>
        <div class="box"       data-x="6" data-y="1"></div>
        <div class="box white" data-x="7" data-y="1"></div>
        <div class="box"       data-x="8" data-y="1"></div>
        <div class="box-inner">1</div>
        
        <div class="box-inner"></div>
        <div class="box-inner">A</div>
        <div class="box-inner">B</div>
        <div class="box-inner">C</div>
        <div class="box-inner">D</div>
        <div class="box-inner">E</div>
        <div class="box-inner">F</div>
        <div class="box-inner">G</div>
        <div class="box-inner">H</div>
        <div class="box-inner"></div>
      </div>
    </div>
  </div>

  <div class="cell large-3 text-center" id="player2">
    <% if @player_black %>
        <h3>Player 2 Ready!</h3>
        <h4><%= @player_black.username %></h4>
    <% else %>
        <h3> Searching for Opponent...</h3>
    <% end %>
  </div>

</div>